<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Умная анкета</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@skbkontur/react-ui@4.3.0/styles.css">
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    .question { margin-bottom: 20px; }
    .recommendations { background: #f5f5f5; padding: 15px; border-radius: 5px; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@skbkontur/react-ui@4.3.0/dist/react-ui.umd.js"></script>
  <script>
    const { Button, Input, Select, Gapped, Modal } = window['react-ui'];

    // Данные анкеты
    const questionnaireData = {
      "Директор": [
        { id: "2.1", text: "Сколько контрагентов проверяете за месяц?", answers: ["50 и менее", "Более 50"] },
        { id: "2.1.1", text: "Как проверяете благонадежность?", answers: ["Используем сервис", "Через открытые источники"] },
        { id: "2.2", text: "Работаете с зарубежными компаниями?", answers: ["Нет", "Да"] },
      ],
      "Главный бухгалтер": [ /*...*/ ],
    };

    const recommendations = {
      "1": "Покажите клиенту аналитику списков, наблюдение",
      "2": "Покажите клиенту сводку (все в одном месте), аналитику списков, наблюдение",
      // ... остальные рекомендации
    };

    const App = () => {
      const [managerName, setManagerName] = React.useState("");
      const [currentRole, setCurrentRole] = React.useState(null);
      const [currentQuestionIndex, setCurrentQuestionIndex] = React.useState(0);
      const [answers, setAnswers] = React.useState({});
      const [mode, setMode] = React.useState("linear"); // 'linear' или 'manual'
      const [showRecommendations, setShowRecommendations] = React.useState(false);
      const [analytics, setAnalytics] = React.useState([]);

      const logAction = (question, answer) => {
        setAnalytics(prev => [...prev, {
          timestamp: new Date().toISOString(),
          manager: managerName,
          question,
          answer,
        }]);
      };

      const exportToCSV = () => {
        const csvContent = "data:text/csv;charset=utf-8," 
          + analytics.map(a => `${a.timestamp},${a.manager},${a.question},${a.answer}`).join("\n");
        const link = document.createElement("a");
        link.setAttribute("href", encodeURI(csvContent));
        link.setAttribute("download", `analytics_${managerName}_${new Date().toISOString()}.csv`);
        document.body.appendChild(link);
        link.click();
      };

      const handleSubmit = () => {
        setShowRecommendations(true);
        exportToCSV(); // Автоматический экспорт при завершении
      };

      return (
        <div className="container">
          <h1>Умная анкета</h1>
          {!managerName ? (
            <div>
              <Input placeholder="Ваше имя" value={managerName} onChange={(e) => setManagerName(e.target.value)} />
              <Button onClick={() => logAction("Начало анкеты", `Менеджер: ${managerName}`)}>Далее</Button>
            </div>
          ) : !currentRole ? (
            <div>
              <h3>Выберите должность клиента:</h3>
              <Gapped vertical>
                {Object.keys(questionnaireData).map(role => (
                  <Button key={role} onClick={() => setCurrentRole(role)}>{role}</Button>
                ))}
              </Gapped>
            </div>
          ) : showRecommendations ? (
            <div className="recommendations">
              <h2>Рекомендации для {currentRole}</h2>
              <ul>
                {Object.values(answers).map((recId, i) => (
                  <li key={i}>{recommendations[recId] || "Нет рекомендаций"}</li>
                ))}
              </ul>
              <Button onClick={() => window.location.reload()}>Новая анкета</Button>
            </div>
          ) : (
            <div>
              <h3>Режим: {mode === "linear" ? "Линейный" : "Ручной"}</h3>
              <Button onClick={() => setMode(mode === "linear" ? "manual" : "linear")}>
                Переключить на {mode === "linear" ? "ручной" : "линейный"}
              </Button>
              {/* Логика анкеты... */}
              <Button onClick={handleSubmit}>Завершить</Button>
            </div>
          )}
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById("root"));
  </script>
</body>
</html>
